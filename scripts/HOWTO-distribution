This is the HOWTO file to make a complete SourceForge downloadable
distribution.  ($Revision$)

If you're building locally:
    You need to have installed NSIS from http://nsis.sourceforge.net (we use version 2.44)

================================================================================
First, we merge in as much tentative content as possible to the SVN trunk.

( ) If it's a new year, update copyright dates (done for 2010):
    * build.xml (2) in the javadoc instructions
    * site/Copyright.html (3 places)
    * xml/XSLT masters and stylesheets
    * (grep -r for the previous year in the web site, xml; don't change copyright notices!)
    * Windows installer script
        bbedit WinInstallFiles/InstallJMRI.nsi
    * Linux scripts
        bbedit DecoderPro PanelPro SoundPro cornwall JmriDemo LocoTools InstallTest DispatcherPro SignalPro DecoderPro3
    * Mac apps (two mentions)
        bbedit MacOSXapps/V1/*.app/Contents/Info.plist

( ) Bring in all possible sf.net patches, including decoders

( ) Check if the decoder definitions have changed since the previous release (almost always true)
    If so, remake the decoder index. 
        Delete old index from preferences
        ant remakedecoderindex
        Change file to Unix line ends.
        Diff w file in SVN tree as a check.
        Copy the new file from preferences into the SVN tree.
        Update the internal version number by hand, adding 2.
        Commit.
    
( ) Update the help/en/Acknowledgements.shtml help page with any recent changes

( ) Commit any changes in your local web site directory, these can end up in help, xml, etc

( ) Remake the help index  (need a command line approach, so can put in ant!)
    ./JHelpDev.csh   (See the doc page for setup)
    (navigate to JHelpDev.xml in release & open it)
    (click "generate all")

    In that same directory, also remake the index and toc web
    pages by doing invoking ant (no argument needed). 
    
    ant
    
    (You may need to remove the DOCTYPE lines, as the Sun DTD may be
    unavailable:  Map.jhm, JmriHelp_enTOC.xml, JmriHelp_enIndex.xml)
    
    Run the program and make sure help works.
    
    Commit any changed files.

( ) Confirm that all the above changes have been committed back to SVN trunk

( ) This is a good place to check that the JavaDocs generate without errors.
    If you fix anything, commit it back.

( ) This is a good place to check that the decoder XSLT transforms work
        cd xml/XSLT
        ant
    If you fix anything, commit it back.


================================================================================
Second, we build the release branch:

( ) Start the release by copying the current HEAD onto a new SVN "release branch"

    svn cp ${SVNREPO}/trunk/jmri ${SVNREPO}/releases/Release-2-13-1

( ) Move to the releases/ part of the SVN tree on your local machine
    and update to get the release copy:
    
    cd ../../releases
    svn update Release-2-13-1
    
    ( to move later changes, svn merge -c <changeset#>   ^/trunk/jmri )

================================================================================
Third, we do any necessary release-specific updates.
    (we need to work through automation of version number values)

( ) Check that the Version.java file has been updated (both version
    number in two places and copyright date), has released=true set
    and has been committed to SVN on the branch
    
( ) Edit the version number into the top help page:
    bbedit help/en/index.html
                   
( ) Edit the "manifest" file in your development directory, and make sure that the
    version number is correct in four places (this file comes from java/, not scripts/)
        
( ) Update the MacOS X bundle version numbers (three version refs):
    
    cd scripts
    bbedit MacOSXapps/V1/*.app/Contents/Info.plist

    sed -i '' s/2.11.8/2.11.9/g MacOSXapps/V1/*.app/Contents/Info.plist

( ) Update version numbers in Linux scripts

    bbedit DecoderPro PanelPro SoundPro cornwall JmriDemo LocoTools InstallTest DispatcherPro SignalPro DecoderPro3

    sed -i '' s/2.11.8/2.11.9/g  DecoderPro PanelPro SoundPro cornwall JmriDemo LocoTools InstallTest DispatcherPro SignalPro DecoderPro3


( ) Update the release number in the build.xml file. This is in three lines on the 1st page:
    <property name="release.major" value="2" />
    <property name="release.minor" value="13" />
    <property name="release.build" value="1" />

( ) run "ant alltests"; make sure they all pass
    
( ) run "ant decoderpro"; check for no startup errors, right version, help index present and working OK.

( ) Commit back; if using CI builds, this will trigger them

( ) Announce final file set to jmridevelopers with a download URL like:

    http://jmri.svn.sourceforge.net/svnroot/jmri/branches/jmri/releases/2.13.1/
        
====================================================================================
Start the actual build! (This is for local builds; CI builds will already be running)

( ) ant -Dnsis.home="" packages
	
    Ant will do the various builds, construct the distribution
    directories, and finally construct the Linux, MacOS X and Windows
    distribution files in dist/releases/
	
( ) The next few steps can be done in parallel.

** Consider testing Windows installer on a VM

( ) Put the Linux, Mac OS X and Windows files where developers can
    take a quick look, send an email, and WAIT FOR SOME REPLIES
    
====================================================================================
Final release steps:

( ) Upload the Linux, Mac OS X and Windows files to sourceforge
     
    Manually:
    scp JMRI.2.11.8.tgz jacobsen,jmri@"frs.sourceforge.net:/home/frs/project/j/jm/jmri/test\ files/"

    Wait until the downloads have propagated to the mirrors; check 
    by trying to download each file
    
    Ask JMRI-developers for a quick look _AND_ _WAIT_ _FOR_ _IT_!!

( ) Any time after "ant packages" is complete, create and upload the JavaDocs
    and XSLT'd decoder pages (you need to have Java 1.6 in ~/.ant/ant.conf)
    
	ant javadoc-uml
	ant uploadjavadoc
	cd xml/XSLT
	ant
	ant upload
	
	Set ~/.ant/ant.conf back to Java 1.5 afterwards
	
( ) Format the release note page, change date, etc

( ) Commit release note files to the web site SVN directory
    
( ) Complete all the above before continuing

( ) Update the web site front page and downloads page
    		
( ) If the decoder definitions have changed, make a .zip file and send to:
    Graham Plowman: gppsoftware@gppsoftware.com

( ) Create the start of a release note for the next version

( ) Commit site
	
( ) File copyright registration

    https://eco.copyright.gov/eService_enu/   (Firefox only!)

( ) Wait for update on JMRI web server

( ) Mail announcement to jmriusers@yahoogroups.com
    Subject is "Test version 2.11.8 of JMRI/DecoderPro is available for download"

( ) Mail announcement to jmri-announce@lists.sourceforge.net

( ) News item from JMRI sourceforge page, Develop tab

	Title is of the form "JMRI 2.11.8 test version is available";
	text is pretty much directly taken from the release note

( ) If a production version, update the SF automatic download icon by selecting default in FRS
        
( ) Decide if worth announcing elsewhere (production version or 
	big system-specific fix/feature):
	    RailRoadSoftware&yahoogroups.com
		MAC_DCC@yahoogroups.com
		loconet_hackers@yahoogroups.com
		digitrax@yahoogroups.com
		NCE-DCC@yahoogroups.com
		NCE-SYS1@yahoogroups.com
		easydcc@yahoogroups.com
		Model_TRAINS_DCC_Software@yahoogroups.com
		DigitalPlusbyLenz@yahoogroups.com
		linux-dcc@yahoogroups.com
		rrsoftware@yahoogroups.com
		Apple MacOS Software
		
( ) Commit back any changes made to this doc

( ) Take a break!

