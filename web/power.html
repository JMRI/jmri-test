<!DOCTYPE html>
<html>
    <head>
        <meta name = "viewport" content = "width = device-width" />
        <title>JSON Set Power Demonstration</title>
        <style>
            html {background-color:#eeeeee}
            body {
                background-color:#ccffcc;
                font-family:Tahoma,Arial,Helvetica,sans-serif;
                font-size:12px;
                margin-left:15%;
                margin-right:15%;
                border:3px groove #006600;
                padding:15px
            }
            h1   {
                text-align:left;
                font-size:1.5em;
                font-weight:bold
            }
        </style>
        <!-- include the jquery.jmri library and its dependencies -->
        <script src="/js/jquery-1.11.0.min.js"></script>
        <script src="/js/json2.js"></script>
        <script src="/js/jquery.websocket.js"></script>
        <script src="/js/jquery.jmri.js"></script>
        <script type="text/javascript">
            // set the jmri global variable to null
            var jmri = null;
            $(document).ready(function() {
                // once the document is loaded, create assign a $.JMRI object to
                // the jmri variable and overload two functions: open() and power()
                jmri = $.JMRI({
                    // call getPower() when the JMRI WebSocket connection opens
                    open: function() {
                        jmri.getPower();
                    },
                    // when the JMRI object receives a power update, call this
                    // function, regardless of source of update
                    power: function(state) {
                        power = state;
                        switch (power) {
                            case jmri.UNKNOWN:
                                $('#powerImg').prop('src', "/images/PowerGrey.png");
                                $('#powerImg').prop('alt', "Unknown");
                                break;
                            case jmri.POWER_ON:
                                $('#powerImg').prop('src', "/images/PowerGreen.png");
                                $('#powerImg').prop('alt', "Powered On");
                                break;
                            case jmri.POWER_OFF:
                                $('#powerImg').prop('src', "/images/PowerRed.png");
                                $('#powerImg').prop('alt', "Powered Off");
                                break;
                        }
                    }
                });
                // if the JMRI WebSocket was open before we overloaded the
                // open function(), we call getPower() immediately
                if (jmri.socket && jmri.socket.readyState === 1) {
                    jmri.getPower();
                } else {
                    // if the JMRI WebSocket was not open when the document was
                    // ready, wait one second and call getPower() if the socket
                    // did not open in the meantime -- this allows the power
                    // request to function if WebSockets are not supported by
                    // the browser
                    setTimeout(function() {
                        if (!jmri.socket || jmri.socket.readyState !== 1) {
                            jmri.getPower();
                        }
                    }, 1000);
                }
            });
        </script>

    </head>
    <body>
        <h1>JSON Set Power Demonstration</h1>
        <hr />
        <p>This sample page sends a request to change layout power when clicked.
            This page will update the power button automatically as it the track
            power is changed elsewhere in JMRI.</p>
        <p>The button is grey if the power state is unknown, green if powered
            on, and red if powered off.</p>
        <div id='power'>
            <a href="javascript:jmri.setPower((power == jmri.POWER_ON) ? jmri.POWER_OFF : jmri.POWER_ON);">
                <img id="powerImg" alt="Unknown" src="/images/PowerGrey.png">
            </a>
        </div>
    </body>
</html>