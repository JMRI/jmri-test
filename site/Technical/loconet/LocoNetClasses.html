<!doctype html public "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="Author" content="Bob Jacobsen, LBL">
   <meta name="GENERATOR" content="Mozilla/4.75C-CCK-MCD {C-UDP; EBM-APPLE} (Macintosh; U; PPC) [Netscape]">
   <meta name="Content-Type" content="text/html; charset=iso-8859-1">
   <title>JMRI technical info</title>
</head>
<body>


<A href="../index.html">
<IMG SRC="../../images/logo.gif" ALIGN=RIGHT WIDTH="160" HEIGHT="135" HSPACE="0" VSPACE="0">
</a>

<H1>Information on the JMRI LocoNet implementation</H1>


This page describes various high-level structures of the JMRI LocoNet implementation.
Please see also the 
<A HREF="../doc/jmri/jmrix/loconet/package-summary.html">JavaDocs for the jmrix.loconet package</A>.

<h2>LocoNet-specific values</h2>
The 
<A HREF="../doc/jmri/jmrix/loconet/LnConstants.html">LnConstants class</a>
provides static, final constants to represent
various fields and values in LocoNet messages.  At some point, some of this
should be built into to the specific classes (i.e. LocoNetMessage) so the coding and 
decoding algorithms don't have to appear in so many places.

<h2>Sending and receiving LocoNet messages</h2>

The
<A HREF="../doc/jmri/jmrix/loconet/LocoNetInterface.html">LocoNetInterface</A> class
provides the basic connection to a LocoNet for
user classes. Messages are sent by passing them to a LocoNetInterface
implementation, and you can register with a LocoNetInterface
to be notified of all LocoNet traffic.
<P>
<IMG SRC="LocoNetInterfaceUML.png">
<P>
The 
<A HREF="../doc/jmri/jmrix/loconet/LocoNetMessage.html">LocoNetMessage</A> class
represents the basic message.  Currently (July 2001), this 
class doesn't really help other code construct and decode LocoNet packets, but
rather just contains them.  This should be improved.
<P>
The steps to send a message to the LocoNet are:
<OL>
<LI>Create a <A HREF="../doc/jmri/jmrix/loconet/LocoNetMessage.html">LocoNetMessage</A> object,
and fill it with the message you want to send.  It's not necessary to fill in the
error-check byte; that will be done as part of sending.
<LI>Locate an object providing a 
<A HREF="../doc/jmri/jmrix/loconet/LocoNetInterface.html">LocoNetInterface</A>
interface.  In many cases, the 
<A HREF="../doc/jmri/jmrix/loconet/LnTrafficController.html">LnTrafficController</A> is providing this, and the
object can be located with
	<PRE>
		LocoNetInterface l = LnTrafficController.instance();
	</PRE>
<LI>Send the message:
	<PRE>
		l.sendLocoNetMessage(msg);
	</PRE>
</OL>

<P>
Classes that want to receive inbound LocoNet packets should implement the 
<A HREF="../doc/jmri/jmrix/loconet/LocoNetListener.html">LocoNetListener</A> interface, 
and register their desire to listen 
via an object with a 
<A HREF="../doc/jmri/jmrix/loconet/LocoNetInterface.html">LocoNetInterface</A> interface.  
It's important to note that
listener objects can't assume that they receive incoming LocoNet messages 
in any specific thread.  In particular, they should not assume that they 
receive these messages in a GUI thread, so they'll have to forward any
changes to the user interface.

<h2>Implementing the LocoNet connection</h2>
Implementing communication with a real LocoNet is handled by 
classes that implement the LocoNetListener interface.
There are currently two: 
<A HREF="../doc/jmri/jmrix/loconet/LnTrafficController.html">LnTrafficController</a>
and its subclass 
<A HREF="../doc/jmri/jmrix/loconet/LnTrafficPacketizer.html">LnTrafficPacketizer</a>.

<h3>LnTrafficController</h3>
The 
<A HREF="../doc/jmri/jmrix/loconet/LnTrafficController.html">LnTrafficController</a>
class provides a scatter-gather operation for the LocoNetListener interface.


<h3>LnTrafficPacketizer</h3>
The
<A HREF="../doc/jmri/jmrix/loconet/LnTrafficPacketizer.html">LnTrafficPacketizer</a>
class extends the LnTrafficController implementation to send and receive
packets over a LocoBuffer serial link to a LocoNet.

It works with an implementation of the 
<A HREF="../doc/jmri/jmrix/loconet/LnPortController.html">LnPortController</A> - 
Abstract class, which works at the level of character streams.


These communicate through Java streams which carry the LocoNet messages as 
character sequences.  


<h3>Startup</h3>
There are "action" classes that connect to an input source.   The main 
program puts these in a menu, on a button, etc, so that the user can select the
connection desired.

<h4>MS100</h4>

Note that the current MS100 implementation is not as robust as we really need it to be.
In particular, back-off and retransmit is not being checked.  The best solution
available right now is to use a LocoBuffer instead of an MS100 for access to the
LocoNet; that has a PIC in it that handles all this properly.
<P>

The MS100Action class (package jmrix.loconet.ms100) starts up a LocoNet connection
via a MS100.  When triggered, it creates a visible MS100Frame object.
<P>
In turn, the MS100Frame creates an MS100Adapter object, 
then shows the available comm ports, allowing the user to pick one.
The MS100Adapter object implements the LnPortController interface, so 
it can eventually connect an LnTrafficController to a serial port and MS100.
<P>
When the "Open MS100 port" button is pressed, the MS100Frame object
<UL>
<LI>passes the selected communication port
to the MS100Adapter.  The MS100 adapter then
connects to that port and creates
input and output streams
<LI>then makes sure that
a LnTrafficController object exists by calling the LnTrafficController.instance
method
<LI>connects that LnTrafficController instance to the MS100Adapter (subclass of LnPortController)
<LI>starts LnTrafficController in a new thread so that it can handle inbound
messages asynchronously.
</UL>

<h4>LocoBuffer</h4>

Very similar to the MS100 case, with the same sequence of operations.  The port setup
is somewhat different. Classes are in the jmrix.loconet.locobuffer package.

<h4>HexFile</h4>

The HexFile classes (package jmrix.loconet.hexfile) are meant to
simulate a LocoNet connection from a data file.  The data file feeds in messages
as if they came from an outside connection.  

<P>Initialization is provided by the HexFileAction class.
When triggered, it creates a visible HexFileFrame object. 
This provides a button the user can use to select an input file.
<P>
When a file is selected, the HexFileFrame object
<UL>
<LI>creates a HexFileAdapter object
connected to that file
<LI>then makes sure that
a LnTrafficController object exists by calling the LnTrafficController.instance
method
<LI>connects that LnTrafficController instance to the HexFileAdapter (subclass of LnPortController)
<LI>starts LnTrafficController in a new thread so that it can handle inbound
messages asynchronously.
</UL>
<P>
Unlike the
MS100Frame and LocoBufferFrame objects, the HexFileFrame object stays
visible so that it can control the flow of messages from the file.

<h3>Slot and Programmer management</h3>

"Slots" are basic to the operation of a LocoNet command station.  They are represented
by the LocoNetSlot class.  Like LocoNetMessage, this class does not (yet) provide a lot
of support for creating and decoding slot status.  The SlotManager class listens to LocoNet
traffic to keep an up-to-date idea of the command stations slot contents.  It ma someday
be necessary for the SlotManager to actively communicate with the command station to 
update that information, but for not the SlotManager only listens to slot change commands that
originate on the LocoNet or are transmitted from the program.
<P>
The SlotListener interface should be implemented by any class that wants to be 
notified when a slot changes.
<P>
Because Digitrax command stations handle programming via a special reserved
slot, the jmri.Programmer interface is also implemented by the loconet.SlotManager class.
This greatly complicates the class, but is acceptable for now.

<HR>
<BR>Site hosted by: <BR>
<A href="http://sourceforge.net"> 
<IMG src="http://sourceforge.net/sflogo.php?group_id=26788&type=1" width="88" height="31" border="0" alt="SourceForge Logo"> </A> 

<!-- Begin Small Box -->
<form method="POST" action="http://mindit.netmind.com/mindit.shtml">
<input type="hidden" name="FORM" value="C">
<table border="0" cellpadding="5" cellspacing="0" bgcolor="#666666"><tr><td align="center">
<font face="arial,helvetica" size="-1" color="#ffffff"><b>Click to receive email <br>when this page changes</b></font></td>
</tr><tr><td align="center">
<input type="image" src="http://mindit.netmind.com/images/mindit.gif" border="0"></td>
</tr><tr bgcolor="#FFFFCC"><td align="center">
<font face="arial,helvetica" size="-2">&#149;<b> Powered by <a href="http://www.netmind.com"><font color="#000000">NetMind</font></a> </b>&#149;</font>
</td></tr></table>
<input type=hidden value="http://jmri.sourceforge.net/Technical/LocoNetClasses.html" name="REDIRECT"> 
</form>
<!-- End Small Box -->

<hr>
Bob Jacobsen<BR>
jake@physics.berkeley.edu

</body>
</html>
