<!doctype html public "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="Author" content="Bob Jacobsen, LBL">
   <meta name="GENERATOR" content="Mozilla/4.75C-CCK-MCD {C-UDP; EBM-APPLE} (Macintosh; U; PPC) [Netscape]">
   <meta name="Content-Type" content="text/html; charset=iso-8859-1">
   <title>JMRI technical info</title>
</head>
<body>


<H2>Information on the JMRI LocoNet implementation</H2>

The LnConstants class provides static, final constants to represent
various fields and values in LocoNet messages.  At some point, some of this
should be built into to the specific classes (i.e. LocoNetMessage) so the coding and 
decoding algorithms don't have to appear in so many places.

<h3>LocoNet traffic handling</h3>

Note that the current implementation is not as robust as we really need it to be.
In particular, back-off and retransmit is not being checked.

The LocoNetMessage class represents the basic message.  Currently (July 2001), this 
class doesn't really help other code construct and decode LocoNet packets, but
rather just contains them.  This should be improved.
<P>
Classes that want to receive inbound LocoNet packets should implement the 
LocoNetListener interface, and register their desire to listen 
via an object with a LocoNetInterface interface.

<P>
Implementing communication with a real LocoNet is handled by two classes:
<UL>
<LI>LnPortController - Abstract class, works at the level of character streams.
Implemented by MS100Adapter to provide character-stream connections to a MS100 
unit via a serial port.
<LI>LnTrafficController - Concrete class, works at the level of messages.
</UL>
These communicate through Java streams which carry the LocoNet messages as 
character sequences.  
<P>
The HexFile class also provides a LocoNetInterface. This is intended for playing back
recorded traffic as a way of debugging.

<h3>Startup</h3>
There are two "action" classes that connect to an input source.   The main 
program puts these in a menu, on a button, etc, so that the user can select the
connection desired.

<h4>MS100</h4>

The MS100Action class (package jmrix.loconet.ms100) starts up a LocoNet connection
via a MS100.  When triggered, it creates a visible MS100Frame object.
<P>
In turn, the MS100Frame creates an MS100Adapter object, 
then shows the available comm ports, allowing the user to pick one.
The MS100Adapter object implements the LnPortController interface, so 
it can eventually a LnTrafficController to a serial port and MS100.
<A>
When the "Open MS100 port" button is pressed, the MS100Frame object
<UL>
<LI>passes the selected communication port
to the MS100Adapter.  The MS100 adapter then
connects to that port and creates
input and output streams
<LI>then makes sure that
a LnTrafficController object exists by calling the LnTrafficController.instance
method
<LI>connects that LnTrafficController instance to the MS100Adapter (subclass of LnPortController)
<LI>starts LnTrafficController in a new thread so that it can handle inbound
messages asynchronously.
</UL>

<h4>HexFile</h4>

The basic procedure for HexFile is similar to MS100. It starts with a 
HexFileAction object (package jmrix.loconet.hexfile)

<h3>Slot and Programmer management</h3>

"Slots" are basic to the operation of a LocoNet command station.  They are represented
by the LocoNetSlot class.  Like LocoNetMessage, this class does not (yet) provide a lot
of support for creating and decoding slot status.  The SlotManager class listens to LocoNet
traffic to keep an up-to-date idea of the command stations slot contents.  It ma someday
be necessary for the SlotManager to actively communicate with the command station to 
update that information, but for not the SlotManager only listens to slot change commands that
originate on the LocoNet or are transmitted from the program.
<P>
The SlotListener interface should be implemented by any class that wants to be 
notified when a slot changes.
<P>
Because Digitrax command stations handle programming via a special reserved
slot, the jmri.Programmer interface is also implemented by the loconet.SlotManager class.
This greatly complicates the class, but is acceptable for now.

<HR>
<BR>Site hosted by: <BR>
<A href="http://sourceforge.net"> 
<IMG src="http://sourceforge.net/sflogo.php?group_id=26788&type=1" width="88" height="31" border="0" alt="SourceForge Logo"> </A> 

<!-- Begin Small Box -->
<form method="POST" action="http://mindit.netmind.com/mindit.shtml">
<input type="hidden" name="FORM" value="C">
<table border="0" cellpadding="5" cellspacing="0" bgcolor="#666666"><tr><td align="center">
<font face="arial,helvetica" size="-1" color="#ffffff"><b>Click to receive email <br>when this page changes</b></font></td>
</tr><tr><td align="center">
<input type="image" src="http://mindit.netmind.com/images/mindit.gif" border="0"></td>
</tr><tr bgcolor="#FFFFCC"><td align="center">
<font face="arial,helvetica" size="-2">&#149;<b> Powered by <a href="http://www.netmind.com"><font color="#000000">NetMind</font></a> </b>&#149;</font>
</td></tr></table>
<input type=hidden value="http://jmri.sourceforge.net/Technical/LocoNetClasses.html" name="REDIRECT"> 
</form>
<!-- End Small Box -->

<hr>
Bob Jacobsen<BR>
jake@physics.berkeley.edu

</body>
</html>
