<?xml version="1.0"?>
<?xml-stylesheet type="text/xsl" href="../XSLT/decoder.xsl"?>
<!DOCTYPE decoder-config SYSTEM "../DTD/decoder-config.dtd">

<!-- Copyright (C) JMRI 2007 All rights reserved -->
<!-- See the COPYING file for more information on licensing and appropriate use -->
<!-- $Id: Massoth_LGB.xml,v 1.3 2007-09-21 04:59:32 jacobsen Exp $ -->

<decoder-config>
		<version author="Jeff Schmaltz escopetas@comcast.net"
			version="1.1" lastUpdated="20070204" />
		<version author="Jeff Schmaltz escopetas@comcast.net"
			version="1.0" lastUpdated="20060923" />

<!-- 
      This decoder XML is meant to be used with the "Custom" programmer format.
      The pane definitions are included below the decoder definition.  The LGB
      decoders seem to fit the description of "weird" as mentioned in that
      programmer.  Also, this allows the tooltips from this decoder file to be
      displayed for the user.

      I have tested this decoder file using the SPROG II interface.  The range
      of versions listed is hypothetical as the versions for all the Massoth/LGB
      decoder types overlap. The highest version I have encountered is 3.4 (in
      both large and small on-board) and the lowest is 1.0 (in a MTS I 55020).

      CV 106 is used by Massoth as "ID for decoder type" and is possibly one way
      of determining decoder type from the CV's, as the version numbers overlap.
      To date, I have encountered the following values in CV 106 (any additions to
      this list would be appreciated):

      55020:           10
      55021:           192
      55022:           16
      Small on-board:  65, 73, 81, 83
      Large on-board:  129, 134
      55027:           193
      eMOTION XL:      193 (according to manual), 200
      eMOTION XLS      202

      This definition was based on the LGB document "CV description for LGB onboard
      decoders, October 5, 2004" (OnboardCVs.pdf, which seems to have disappeared
      from the LGB website, email me for a copy - or if you have an updated version!),
      the documents for the 55020, 55021, and 55022 decoders, plus the instructions
      for some locos. These are all available from the LGB website.

      This decoder file is most proper for the 55021 and 55022 MTS II add-on decoders
      and the small and large on-board decoders.  It can work with the 55020 MTS I
      add-on decoder but this decoder lacks some features, such as back-EMF. Only the
      on-board decoders have the F2 functions.  Not all the features work with all locos.
      Refer to the decoder and loco documentation for details.  However, some features
      may not be documented e.g. the 2 vs. 4 chuff bit worked on a sound-equipped loco
      where it was not mentioned in the instructions!

      I tried to match DeccoderPro "item" names when I was fairly certain they were
      correct.  The "label" names tried to match the names used in the LGB
      documentation.

      Finally, I choose not to specify any "default" values (which then results in
      a default of 0) because of the different defaults in the wide variety of LGB
      locos.

      Any and all feedback on this file would be appreciated.

      Version History:

        1.0 - 23 Sep 06
              Initial release 
        1.1 - 4 Feb 07
              Minor format changes
              Made CV 7, 8, & 106 readOnly (works correctly with 1.7.5+)
              Added CV numbers to tooltips
-->


<decoder>
	<family name="LGB" mfg="Massoth Elektronik, GmbH">
		<model model="LGB MTS loco decoders" lowVersionID="10" highVersionID="39"
                   comment="includes 55021, 55022, large and small on-board decoders">
		</model>
	</family>

	<programming direct="yes" paged="no"
	                     register="yes" ops="no"></programming>

	<variables> 

		<variable label="Short Address" CV="1" 
			item="Short Address"
			tooltip="Sets the Primary 2 digit address - LGB 0-22 for add-on, 1-23 for onboard CV1" >
			<shortAddressVal/>
            </variable>

		<variable label="Starting voltage" CV="2" 
			item="Vstart"
			tooltip="Sets the starting voltage at throttle speed step 1 - 0: slow, 255: maximum speed CV2">
			<decVal min="0" max="255"/>
		</variable>
		
		<variable label="Acceleration" CV="3"
			item="Accel"
			tooltip="Sets the acceleration rate - 1: rapid acceleration, 255: gradual acceleration CV3" >
			<decVal min="1" max="255"/>
		</variable>

		<variable label="Braking" CV="4"
			item="Decel"
			tooltip="Sets the deceleration rate - 1: rapid braking, 255: gradual braking) CV4" >
			<decVal min="1" max="255"/>
		</variable>
		
		<variable label="Maximum Motor Voltage" CV="5"
			item="Vhigh"
			tooltip="Sets the maximum voltage at full throttle - 1: slow, 255: maximum speed CV5">
			<decVal min="1" max="255"/>
		</variable>

		<variable label="Software Version Number" CV="7" readOnly="yes"
			item="Decoder Version"
			tooltip="The decoder version number (read only) CV7" >
			<decVal/>
		</variable>

		<variable label="Manufacturer Code" CV="8" readOnly="yes"
			item="Manufacturer"
			tooltip="The manufacturer's ID number (read only) CV8">
			<decVal/>
		</variable>

		<variable label="Motor Frequency" CV="9"
			item="Total PWM Period"
			tooltip="Sets the motor drive frequency - Note: Back-EMF only works with 16 kHz CV9">
			<enumVal>
				<enumChoice choice="16 kHz"/>
				<enumChoice choice="1.8 kHz"/>
				<enumChoice choice="270 Hz"/>
				<enumChoice choice="70 Hz"/>
			</enumVal>
		</variable>

		<variable label="Long Address" CV="17"
			item="Extended Address"
			tooltip="Sets the Extended 4 digit address (Range 128-10239) (not LGB MTS) CV17-18" >
			<longAddressVal/>
		</variable>

		<variable label="Normal direction of motion" CV="29" mask="XXXXXXXV"
			item="Locomotive Direction"
			tooltip="Sets the relative direction of the loco when told to move forward CV29" >
			<enumVal>
				<enumChoice choice="Forward"/>
				<enumChoice choice="Reverse"/>
			</enumVal>
		</variable>

		<variable label="Speed Steps" CV="29" mask="XXXXXXVX"
			item="Speed Step Mode"
			tooltip="Sets the speed step mode CV29" >
			<enumVal>
				<enumChoice choice="14"/>
				<enumChoice choice="28/128 (not LGB MTS)"/>
			</enumVal>
		</variable>

		<variable label="Analog conversion mode" CV="29" mask="XXXXXVXX"
			item="Analog (DC) Operation"
			tooltip="Determines whether loco can operate on conventional DC current (enables Power Source Conversion) CV29" >
			<enumVal>
				<enumChoice choice="Off"/>
				<enumChoice choice="On"/>
			</enumVal>
		</variable>

		<variable label="Use Speed Table" CV="29" mask="XXXVXXXX"
			item="Speed Table Definition"
			tooltip="Determines whether loco will use manufacturer's internal or user-defined speed step table CV29" >
			<enumVal>
				<enumChoice choice="internal speed step table"/>
				<enumChoice choice="user-programmed speed step table (CV's 67-94)"/>
			</enumVal>
		</variable>

		<variable label="Addressing Mode" CV="29" mask="XXVXXXXX"
			item="Address Format"
			tooltip="Determines whether loco will use short or long address CV29" >
			<enumVal>
				<enumChoice choice="address 1-127 (LGB MTS: 0-22/1-23)"/>
				<enumChoice choice="address 128-10239 (not LGB MTS)"/>
			</enumVal>
		</variable>

		<variable label="Voltage for F1 terminal" CV="49"
			tooltip="Voltage for F1 terminal - 1:low voltage, 5:5V light bulbs or smoke generator, 32:maximum voltage CV49">
			<decVal min="1" max="32"/>
		</variable>

		<variable label="Voltage for lighting terminals" CV="50"
			tooltip="Voltage for front, rear and interior light - 1:low voltage, 5:5V light bulbs, 32:maximum voltage CV50">
			<decVal min="1" max="32"/>
		</variable>

		<variable label="Command for F1 terminal" CV="51"
			tooltip="Command which triggers the F1 terminal CV51">
			<enumVal>
				<enumChoice choice="lighting button (LGB=9, others=0)" value="0"/>
				<enumChoice choice="button 1 (parallel only)" value="1"/>
				<enumChoice choice="button 2 (parallel only)" value="2"/>
				<enumChoice choice="button 3 (parallel only)" value="3"/>
				<enumChoice choice="button 4 (parallel only)" value="4"/>
				<enumChoice choice="button 5 (parallel only)" value="5"/>
				<enumChoice choice="button 6 (parallel only)" value="6"/>
				<enumChoice choice="button 7 (parallel only)" value="7"/>
				<enumChoice choice="button 8 (parallel only)" value="8"/>
				<enumChoice choice="button 1 (parallel and serial)" value="9"/>
				<enumChoice choice="button 2 (parallel and serial)" value="10"/>
				<enumChoice choice="button 3 (parallel and serial)" value="11"/>
				<enumChoice choice="button 4 (parallel and serial)" value="12"/>
				<enumChoice choice="button 5 (parallel and serial)" value="13"/>
				<enumChoice choice="button 6 (parallel and serial)" value="14"/>
				<enumChoice choice="button 7 (parallel and serial)" value="15"/>
				<enumChoice choice="button 8 (parallel and serial)" value="16"/>
				<enumChoice choice="lighting button (LGB=9, others=0) (on only when loco is reversing)" value="64"/>
				<enumChoice choice="button 1 (on only when loco is reversing)" value="65"/>
				<enumChoice choice="lighting button (LGB=9, others=0) (on only when loco is moving forward)" value="128"/>
				<enumChoice choice="button 1 (on only when loco is moving forward)" value="129"/>
			</enumVal>
		</variable>

		<variable label="Command for front lighting terminal" CV="52"
			tooltip="Command which triggers the front light terminal CV52">
			<enumVal>
				<enumChoice choice="lighting button (LGB=9, others=0)" value="0"/>
				<enumChoice choice="button 1 (parallel only)" value="1"/>
				<enumChoice choice="button 2 (parallel only)" value="2"/>
				<enumChoice choice="button 3 (parallel only)" value="3"/>
				<enumChoice choice="button 4 (parallel only)" value="4"/>
				<enumChoice choice="button 5 (parallel only)" value="5"/>
				<enumChoice choice="button 6 (parallel only)" value="6"/>
				<enumChoice choice="button 7 (parallel only)" value="7"/>
				<enumChoice choice="button 8 (parallel only)" value="8"/>
				<enumChoice choice="button 1 (parallel and serial)" value="9"/>
				<enumChoice choice="button 2 (parallel and serial)" value="10"/>
				<enumChoice choice="button 3 (parallel and serial)" value="11"/>
				<enumChoice choice="button 4 (parallel and serial)" value="12"/>
				<enumChoice choice="button 5 (parallel and serial)" value="13"/>
				<enumChoice choice="button 6 (parallel and serial)" value="14"/>
				<enumChoice choice="button 7 (parallel and serial)" value="15"/>
				<enumChoice choice="button 8 (parallel and serial)" value="16"/>
				<enumChoice choice="lighting button (LGB=9, others=0) (on only when loco is reversing)" value="64"/>
				<enumChoice choice="button 1 (on only when loco is reversing)" value="65"/>
				<enumChoice choice="lighting button (LGB=9, others=0) (on only when loco is moving forward)" value="128"/>
				<enumChoice choice="button 1 (on only when loco is moving forward)" value="129"/>
			</enumVal>
		</variable>

		<variable label="Command for rear lighting terminal" CV="53"
			tooltip="Command which triggers the rear light terminal CV53">
			<enumVal>
				<enumChoice choice="lighting button (LGB=9, others=0)" value="0"/>
				<enumChoice choice="button 1 (parallel only)" value="1"/>
				<enumChoice choice="button 2 (parallel only)" value="2"/>
				<enumChoice choice="button 3 (parallel only)" value="3"/>
				<enumChoice choice="button 4 (parallel only)" value="4"/>
				<enumChoice choice="button 5 (parallel only)" value="5"/>
				<enumChoice choice="button 6 (parallel only)" value="6"/>
				<enumChoice choice="button 7 (parallel only)" value="7"/>
				<enumChoice choice="button 8 (parallel only)" value="8"/>
				<enumChoice choice="button 1 (parallel and serial)" value="9"/>
				<enumChoice choice="button 2 (parallel and serial)" value="10"/>
				<enumChoice choice="button 3 (parallel and serial)" value="11"/>
				<enumChoice choice="button 4 (parallel and serial)" value="12"/>
				<enumChoice choice="button 5 (parallel and serial)" value="13"/>
				<enumChoice choice="button 6 (parallel and serial)" value="14"/>
				<enumChoice choice="button 7 (parallel and serial)" value="15"/>
				<enumChoice choice="button 8 (parallel and serial)" value="16"/>
				<enumChoice choice="lighting button (LGB=9, others=0) (on only when loco is reversing)" value="64"/>
				<enumChoice choice="button 1 (on only when loco is reversing)" value="65"/>
				<enumChoice choice="lighting button (LGB=9, others=0) (on only when loco is moving forward)" value="128"/>
				<enumChoice choice="button 1 (on only when loco is moving forward)" value="129"/>
			</enumVal>
		</variable>

		<variable label="hand-over function" CV="54" mask="XXXXXXXV">
			<enumVal>
				<enumChoice choice="off"/>
				<enumChoice choice="on"/>
			</enumVal>
		</variable>

		<variable label="MTS Back-EMF" CV="54" mask="XXXXXXVX">
			<enumVal>
				<enumChoice choice="off"/>
				<enumChoice choice="on"/>
			</enumVal>
		</variable>

		<variable label="analog Back-EMF" CV="54" mask="XXXXXVXX">	
			<enumVal>
				<enumChoice choice="off"/>
				<enumChoice choice="on"/>
			</enumVal>
		</variable>

		<!-- Bits 4-8 of "LGB Configuration" CV54 are loco dependent -->
		<!-- I've only come across one example (21812) and would  -->
		<!-- appreciate other examples of how these bits are used -->

		<variable label="Loco dependent bit 4" CV="54" mask="XXXXVXXX">
			<enumVal>
				<enumChoice choice="0 - e.g. Load-dependent chuff off"/>
				<enumChoice choice="1 - e.g. Load-dependent chuff on"/>
			</enumVal>
		</variable>

		<variable label="Loco dependent bit 5" CV="54" mask="XXXVXXXX">
			<enumVal>
				<enumChoice choice="0 - e.g. F1 permanently on"/>
				<enumChoice choice="1 - e.g. F1 flashing"/>
			</enumVal>
		</variable>

		<variable label="Loco dependent bit 6" CV="54" mask="XXVXXXXX">
			<enumVal>
				<enumChoice choice="0 - e.g. F2 permanently on"/>
				<enumChoice choice="1 - e.g. F2 flashing"/>
			</enumVal>
		</variable>

		<variable label="Loco dependent bit 7" CV="54" mask="XVXXXXXX">
			<enumVal>
				<enumChoice choice="0 - e.g. Number of chuffs 2"/>
				<enumChoice choice="1 - e.g. Number of chuffs 4"/>
			</enumVal>
		</variable>

		<variable label="Loco dependent bit 8" CV="54" mask="VXXXXXXX">
			<enumVal>
				<enumChoice choice="0 - e.g. Automatic sounds on"/>
				<enumChoice choice="1 - e.g. Automatic sounds off"/>
			</enumVal>
		</variable>

		<variable label="Reset Register" CV="55" 
			tooltip="Write 55 into CV 55 to reset to factory settings CV55">
			<decVal min="55" max="55"/>
		</variable>

		<variable label="Voltage for F2 terminal" CV="56"
			tooltip="Voltage for F2 terminal - 1:low voltage, 5:5V light bulbs or smoke generator, 32:maximum voltage CV56">
			<decVal min="1" max="32"/>
		</variable>

		<variable label="Command for F2 terminal" CV="57"
			tooltip="Command which triggers the F2 terminal CV57">
			<enumVal>
				<enumChoice choice="lighting button (LGB=9, others=0)" value="0"/>
				<enumChoice choice="button 1 (parallel only)" value="1"/>
				<enumChoice choice="button 2 (parallel only)" value="2"/>
				<enumChoice choice="button 3 (parallel only)" value="3"/>
				<enumChoice choice="button 4 (parallel only)" value="4"/>
				<enumChoice choice="button 5 (parallel only)" value="5"/>
				<enumChoice choice="button 6 (parallel only)" value="6"/>
				<enumChoice choice="button 7 (parallel only)" value="7"/>
				<enumChoice choice="button 8 (parallel only)" value="8"/>
				<enumChoice choice="button 1 (parallel and serial)" value="9"/>
				<enumChoice choice="button 2 (parallel and serial)" value="10"/>
				<enumChoice choice="button 3 (parallel and serial)" value="11"/>
				<enumChoice choice="button 4 (parallel and serial)" value="12"/>
				<enumChoice choice="button 5 (parallel and serial)" value="13"/>
				<enumChoice choice="button 6 (parallel and serial)" value="14"/>
				<enumChoice choice="button 7 (parallel and serial)" value="15"/>
				<enumChoice choice="button 8 (parallel and serial)" value="16"/>
				<enumChoice choice="lighting button (LGB=9, others=0) (on only when loco is reversing)" value="64"/>
				<enumChoice choice="button 1 (on only when loco is reversing)" value="65"/>
				<enumChoice choice="lighting button (LGB=9, others=0) (on only when loco is moving forward)" value="128"/>
				<enumChoice choice="button 1 (on only when loco is moving forward)" value="129"/>
			</enumVal>
		</variable>

		<variable label="Pause Time between changes in direction" CV="58"
			tooltip="Pause equals programmed value x 0.5 seconds CV58">
			<decVal min="0" max="255"/>
		</variable>

		<!-- Found reference to this CV in Instructions for 23900 MTS-DUO switcher -->
		<!-- Not sure how it relates to using F8 to switch half-speed mode on and off -->
		<!-- Checked Instructions for a couple of other small diesels but no mention of CV59 -->
		<variable label="Half-speed mode" CV="59" mask="XXXXXVXX"
			tooltip="May only apply to 23900 MTS-DUO switcher CV59" >
			<enumVal>
				<enumChoice choice="Half-speed mode deactivated"/>
				<enumChoice choice="Half-speed mode activated"/>
			</enumVal>
		</variable>

		<variable label="Back-EMF Maximum Adjustment Factor" CV="60"
			tooltip="1: small steps, 255: large steps (Note: LGB recommends not changing this CV) CV60">
			<decVal min="1" max="255"/>
		</variable>

		<variable label="Back-EMF Adjustment Frequency" CV="61"
			tooltip="0: immediate adjustment, 255: maximum delay (Note: LGB recommends not changing this CV) CV61">
			<decVal min="0" max="255"/>
		</variable>

		<variable label="Back-EMF Maximum Adjustment" CV="62"
			tooltip="0: no adjustment, 255: maximum adjustment (Note: LGB recommends not changing this CV) CV62">
			<decVal min="0" max="255"/>
		</variable>

		<variable label="Speed Table" CV="67">
			<speedTableVal>
				<speedTableEntry step="1" value="8"/>
				<speedTableEntry step="2" value="16"/>
				<speedTableEntry step="3" value="24"/>
				<speedTableEntry step="4" value="32"/>
				<speedTableEntry step="5" value="40"/>
				<speedTableEntry step="6" value="48"/>
				<speedTableEntry step="7" value="56"/>
				<speedTableEntry step="8" value="64"/>
				<speedTableEntry step="9" value="72"/>
				<speedTableEntry step="10" value="80"/>
				<speedTableEntry step="11" value="88"/>
				<speedTableEntry step="12" value="96"/>
				<speedTableEntry step="13" value="104"/>
				<speedTableEntry step="14" value="112"/>
				<speedTableEntry step="15" value="120"/>
				<speedTableEntry step="16" value="128"/>
				<speedTableEntry step="17" value="136"/>
				<speedTableEntry step="18" value="144"/>
				<speedTableEntry step="19" value="152"/>
				<speedTableEntry step="20" value="160"/>
				<speedTableEntry step="21" value="168"/>
				<speedTableEntry step="22" value="176"/>
				<speedTableEntry step="23" value="184"/>
				<speedTableEntry step="24" value="192"/>
				<speedTableEntry step="25" value="208"/>
				<speedTableEntry step="26" value="224"/>
				<speedTableEntry step="27" value="240"/>
				<speedTableEntry step="28" value="255"/>
			</speedTableVal>
		</variable>

		<!-- Do not attempt to read CV 105 on an LGB decoder -->

		<variable label="ID for Decoder Type" CV="106" readOnly="yes" 
			item="Product number"
			tooltip="ID for Decoder Type (read only) CV106">
			<decVal/>
		</variable>

	</variables>
</decoder>

<pane name="Basic">
		<column>
			<dccaddress />
			<label label=" "/>
			<display item="Short Address" />
			<display item="Long Address" />
			<display item="Address Format" />
			<label label=" "/>
			<display item="Locomotive Direction" />
			<display item="Speed Step Mode" />
			<display item="Analog (DC) Operation" />
		</column>
		<column>
			<label label=" "/>
			<label label=" "/>
			<label label=" "/>
			<separator/>
			<label label=" "/>
			<display item="Manufacturer" />
			<display item="Decoder Version" />
			<display item="Product number" />
		</column>
	</pane>

	<pane name="Motor">
		<column>
			<display item="Accel" />
			<display item="Decel" />
			<label label=" "/>
			<display item="Total PWM Period" />
			<label label=" "/>
			<display item="Pause Time between changes in direction" />
			<label label=" "/>
			<display item="MTS Back-EMF"/>
			<display item="analog Back-EMF"/>
			<label label=" "/>
			<display item="Back-EMF Maximum Adjustment Factor"/>
			<display item="Back-EMF Adjustment Frequency"/>
			<display item="Back-EMF Maximum Adjustment"/>
		</column>	</pane>

	<pane name="Speed Control">
		<column>
			<row>
				<column>
					<label label=" "/>
					<display item="Speed Table Definition"
						format="offradiobutton" label=""/>
					<label label=" "/>
				</column>
			</row>
			<row>
				<column>
					<display item="Vstart" />
					<display item="Vhigh" />
				</column>
				<column>
					<display item="Vstart" format="hslider" label="" />
					<display item="Vhigh" format="hslider" label="" />
				</column>
			</row>
			<row>
				<label label=" "/>
			</row>
			<row>
				<label label=" "/>
			</row>
			<separator/>
			<row>
				<column>
					<display item="Speed Table Definition"
						format="onradiobutton" layout="above" label=""/>
				</column>
			</row>
			<row>
				<column>
					<label label=" "/>
					<display item="Speed Table Selection" />
				</column>
			</row>
			<row>
			  <column>
					<display item="Speed Table" layout="above"/>
					<label label=" "/>
				</column>
			</row>
		</column>
	</pane>

	<pane name="Lights and Functions">
		<column>
			<display item="Voltage for lighting terminals"/>
			<display item="Voltage for F1 terminal"/>
			<display item="Voltage for F2 terminal"/>
			<label label=" "/>
			<display item="Command for front lighting terminal"/>
			<display item="Command for rear lighting terminal"/>
			<display item="Command for F1 terminal"/>
			<display item="Command for F2 terminal"/>
			<label label=" "/>
			<display item="Loco dependent bit 5"/>
			<display item="Loco dependent bit 6"/>
		</column>
	</pane>

	<pane name="Sound">
		<column>
			<display item="Loco dependent bit 4"/>
			<display item="Loco dependent bit 7"/>
			<display item="Loco dependent bit 8"/>
		</column>
	</pane>

	<pane name="Miscellaneous">
		<column>
			<display item="hand-over function"/>
			<display item="Half-speed mode"/>
			<display item="Reset Register"/>
		</column>
	</pane>

	<pane name="CVs">
		<column>
			<cvtable/>
		</column>
	</pane>

</decoder-config>
