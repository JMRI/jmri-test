<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<!-- $Id: SPROG.shtml,v 1.1 2008-01-13 04:49:34 jacobsen Exp $ -->
<html lang="en">
<head>
 <TITLE>
      JMRI Hardware Guide: SPROG
 </TITLE>
    <META http-equiv=Content-Type content="text/html; charset=iso-8859-1">
    <META content="Bob Jacobsen" name=Author>
    <META name="keywords" content="SPROG java model railroad JMRI install windows">

<!-- Style -->
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<LINK REL="stylesheet" TYPE="text/css" HREF="/css/default.css"
	MEDIA="screen">
<LINK REL="stylesheet" TYPE="text/css" HREF="/css/print.css"
	MEDIA="print">
<LINK REL="icon" HREF="/images/jmri.ico" TYPE="image/png">
<LINK REL="home" TITLE="Home" HREF="/">
<!-- /Style -->
</HEAD>

<BODY>
<!--#include virtual="/Header" -->

  <div class="nomenu" id="mBody">
    <div id="mainContent">

      <H2> 
      JMRI Hardware Guide: SPROG
      </H2>

	<H3>Supported Hardware</H3>

    JMRI supports the SPROG both as a decoder programmer, and
    also as a mini-command station.  For more information on these
    capabilities, see the 
    <a href="http://www.sprog-dcc.co.uk/downloads/SprogIIUserGuide.pdf">SPROG manual</a>
    on the 
    <a href="http://www.sprog-dcc.co.uk/">SPROG web site</a>.
	<p>Note that there are several different versions
	of the SPROG hardware, and even more versions of the 
	SPROG software. If you're trying to attach an SPROG
	that has been sitting in a drawer for a while, you 
	should probably update it's software to a current version.</P>

	<H3>Setup</H3>

	  <ol>
	  <li> Once you have your SPROG assembled and configured (see
	  below), connect it to the computer's serial port using a 9-pin
	  serial cable. </li>

	  <li> Then go to the preferences panel of a JMRI-based program.  This
	  opens automatically the first time a program is run, or you can select
	  it from the "Edit" menu. </li>

	  <li>Select "SPROG" from the top selection box. You can then select the
	  proper serial port in the second selection box. </li>

	  <li> The series of radio buttons labelled "GUI style" allows you to
	  select how the program will look. "Metal" is the native Java look
	  available on all types. Other choices will vary with your computer type.
	  "Motif", "Windows", "MacOS" and "MacOS Adaptive" look native on Linux,
	  Windows, MacOS "Classic" and MacOS X respectively.</li>

	  <li> In the bottom selection box, you can pick the default programmer
	  format. You can override this each time you open the programmer, so this
	  is here just for convenience. </li>

	  <li> Click "Save".  You'll be asked if it's OK for the program to
	  quit, click "Yes".</li>
	  <li> Restart the program. You should be up and running.</li>
	  </ol>

	<H3>Configuring SPROG</H3>
	  <p>SPROG has 3 operation modes:
	  <ul>
	  <li> P_mode&nbsp;&nbsp; (programming mode)
	  <li> RR_mode&nbsp;&nbsp; (rolling road/test mode)
	  <li> B_mode&nbsp;&nbsp; (booster mode) 
	  </ul>

	  <p>To get SPROG working with DecoderPro properly it needs to be setup to
	  do so with the M and W commands. Fortunately one can use binary values
	  here, so it's very easy to determine the right value using a
	  table.</p>

	  <p>We need to deselect the <TT>ECHO all characters</tt>, the
	  <tt>RR_mode</tt> and the <tt>B_mode</tt>:</p>

	  <table border="1" cellspacing="2" cellpadding="2"
	   style="text-align: left; width: 50%;">

	    <thead><tr><td colspan=17> Table to establish the configuration
	    value:</td></tr>
	    <tbody>
	      <tr>
		<td style="vertical-align: top; text-align: left;">Bit<br>
		</td>
		<td style="vertical-align: top;" align="center">15</td>
		<td style="vertical-align: top;" align="center">14<br>
		</td>

		<td style="vertical-align: top;" align="center">13<br>
		</td>
		<td style="vertical-align: top;" align="center">12<br>
		</td>
		<td style="vertical-align: top;" align="center">11<br>
		</td>
		<td style="vertical-align: top;" align="center">10<br>

		</td>
		<td style="vertical-align: top;" align="center">9<br>
		</td>
		<td style="vertical-align: top;" align="center">8<br>
		</td>
		<td style="vertical-align: top;" align="center">7<br>
		</td>

		<td style="vertical-align: top;" align="center">6<br>
		</td>
		<td style="vertical-align: top;" align="center">5<br>
		</td>
		<td style="vertical-align: top;" align="center">4<br>
		</td>
		<td style="vertical-align: top;" align="center">3<br>

		</td>
		<td style="vertical-align: top;" align="center">2<br>
		</td>
		<td style="vertical-align: top;" align="center">1<br>
		</td>
		<td style="vertical-align: top;" align="center">0<br>
		</td>

	      </tr>
	      <tr>
		<td style="vertical-align: top;">Name<br>
		</td>
		<td style="vertical-align: top;">spare<br>
		</td>
		<td style="vertical-align: top;">spare</td>

		<td style="vertical-align: top;">spare<br>
		</td>
		<td style="vertical-align: top;">LONG<br>
		</td>
		<td style="vertical-align: top;">SP128<br>
		</td>
		<td style="vertical-align: top;">SP28<br>

		</td>
		<td style="vertical-align: top;">SP14<br>
		</td>
		<td style="vertical-align: top;">DIR<br>
		</td>
		<td style="vertical-align: top;">spare<br>
		</td>

		<td style="vertical-align: top;">spare</td>
		<td style="vertical-align: top; text-align: center;">B_<br>
		</td>
		<td style="vertical-align: top; text-align: center;">RR_<br>
		</td>
		<td style="vertical-align: top;">CALC_<br>
		</td>

		<td style="vertical-align: top;">VERBOSE </td>
		<td style="vertical-align: top; text-align: center;">ECHO<br>
		</td>
		<td style="vertical-align: top; text-align: center;">MODE<br>
		</td>
	      </tr>
	      <tr>

		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>

		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>

		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;">MODE<br>
		</td>
		<td style="vertical-align: top;">MODE<br>
		</td>

		<td style="vertical-align: top;">ERROR<br>
		</td>
		<td style="vertical-align: top;"> <br>
		</td>
		<td style="vertical-align: top; text-align: center;">_ON<br>
		</td>
		<td style="vertical-align: top; text-align: center;">_SET<br>

		</td>
	      </tr>
	      <tr>
		<td style="vertical-align: top;">Feature<br>
		</td>
		<td style="vertical-align: top; text-align: center;">allways =0<br>
		</td>
		<td style="vertical-align: top; text-align: center;">allways =0</td>

		<td style="vertical-align: top; text-align: center;">allways =0<br>
		</td>
		<td style="vertical-align: top;">long addr.<br>
		</td>
		<td style="vertical-align: top;">speed steps<br>
		</td>
		<td style="vertical-align: top;">speed steps<br>

		</td>
		<td style="vertical-align: top;">speed steps<br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top; text-align: center;">allways =0<br>
		</td>
		<td style="vertical-align: top; text-align: center;">allways =0</td>

		<td style="vertical-align: top;">booster mode<br>
		</td>
		<td style="vertical-align: top;">rolling road mode<br>
		</td>
		<td style="vertical-align: top;">calc. error byte<br>
		</td>
		<td style="vertical-align: top;">verbose mode </td>

		<td style="vertical-align: top;">echo all characters </td>
		<td style="vertical-align: top;">default prog.mode page=0
	  direct=1 </td>
	      </tr>
	      <tr>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>

		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>

		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>

		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"> <br>
		</td>

		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
	      </tr>
	      <tr>
		<td style="vertical-align: top;">Example<br>
		</td>

		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>

		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>

		<td style="vertical-align: top;"> <br>
		</td>
		<td style="vertical-align: top;"> <br>
		</td>
		<td style="vertical-align: top;"> <br>
		</td>
		<td style="vertical-align: top;"> <br>

		</td>
		<td style="vertical-align: top;"> <br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
	      </tr>

	      <tr>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>

		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>

		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>

		<td style="vertical-align: top;"> <br>
		</td>
		<td style="vertical-align: top;"> <br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>

	      </tr>
	      <tr>
		<td style="vertical-align: top;">Bits set:<br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>

		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top; text-align: center;">X<br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>

		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>

		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top; text-align: center;"> X<br>
		</td>
		<td style="vertical-align: top;"> <br>
		</td>

		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
	      </tr>
	      <tr>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>

		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>

		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"> <br>
		</td>
		<td style="vertical-align: top;"> <br>
		</td>

		<td style="vertical-align: top;"> <br>
		</td>
		<td style="vertical-align: top;"> <br>
		</td>
		<td style="vertical-align: top;"> <br>
		</td>
		<td style="vertical-align: top;"> <br>

		</td>
		<td style="vertical-align: top;"> <br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
		<td style="vertical-align: top;"><br>
		</td>
	      </tr>

	      <tr>
		<td style="vertical-align: top;">Value bin<br>
		</td>
		<td style="vertical-align: top;" align="center">0<br>
		</td>
		<td style="vertical-align: top;" align="center">0<br>
		</td>

		<td style="vertical-align: top;" align="center">0<br>
		</td>
		<td style="vertical-align: top;" align="center">0<br>
		</td>
		<td style="vertical-align: top;" align="center">1<br>
		</td>
		<td style="vertical-align: top;" align="center">0<br>

		</td>
		<td style="vertical-align: top;" align="center">0<br>
		</td>
		<td style="vertical-align: top;" align="center">0<br>
		</td>
		<td style="vertical-align: top;" align="center">0<br>
		</td>

		<td style="vertical-align: top;" align="center">0<br>
		</td>
		<td style="vertical-align: top;" align="center">0<br>
		</td>
		<td style="vertical-align: top;" align="center">0<br>
		</td>
		<td style="vertical-align: top;" align="center">1 </td>

		<td style="vertical-align: top;" align="center"> 0<br>
		</td>
		<td style="vertical-align: top;" align="center">0<br>
		</td>
		<td style="vertical-align: top;" align="center">0<br>
		</td>
	      </tr>

	    </tbody>
	  </table>

	  <p>This will result in a binary value of: b = 0000100000001000</p>

	  <p>To program this into SPROG start a terminal program (like Hyperterm
	  with WIN) and give SPROG a reset. This will show up the following
	  screen:<br>
	  <ul>
	  <tt>
	  SPROG DCC Serial Port Programmer, Ver 1.1a<br>
	  M S P B R W<br>
	  P: C V<br>
	  R: + - &lt; &gt; A F O<br>
	  P&gt;<br>
	  </tt>
	  </ul></p>

	  Entering <tt>M&nbsp;</tt> will return the current configuration (example only!). <br>
	  <ul>
	  <tt>
	  SPROG DCC Serial Port Programmer, Ver 1.1a<br>
	  M S P B R W<br>
	  P: C V<br>
	  R: + - &lt; &gt; A F O<br>

	  P&gt; M=b0001100000011110<br>
	  P&gt;<br>
	  </tt>
	  </ul>

	  <p>Now enter <tt>M b0000100000001000</tt></p>
	  <p>and enter <tt>W b0000100000001000</tt></p>
	  <p>This last operation will program the configuration into the nonvolatile memory.</p>
	  <p>Check by entering <tt>M</tt> , you should see the same value as entered before.</p>

	  <p>Now you are ready to operate SPROG with JMRI.</p>

	<H3>Debugging</H3>

	<p>For more information on the SPROG, please see <a
	   href="http://www.sprog-dcc.co.uk/">the SPROG web
	  pages</a>.</p>
	<p>There is a useful <a
	   href="http://www.sprog-dcc.co.uk/faq.html">FAQ
	   page</a>.</p>

	<p>If you fail to get a connection with DecoderPro, check your serial
	connection on the SPROG board. It should be made as follows <br>
	(all pin locations are for a 9 pin D-SUB female):
	<ul>
	<li> J8&nbsp; -&gt; pin 3
	<li> J9&nbsp; -&gt; pin 2
	<li> J11 -&gt; pin 7
	<li> J15 -&gt; pin 8
	<li> ground -&gt; pin 5
	</ul></p>

	<p> If still no connection, check if you use a MAX232N serial
	driver chip.  This one requires1&micro;F Electrolytic caps instead
	of the specified 100 nF (C 11, 12, 13, 14).</p>

      <hr class="hide">
      
   <h3>Additional capabilities</h3>
   The SPROG can be very useful as a DCC signal
   generator for testing DCC equipment you're developing.
   
   <P>The following description of how SPROG generates the
   output bitstream was kindly provided by Andrew Crosland.
   
   <P>The DCC bitstream is generated is by using the PIC timer TMR0 to
generate a regular interrupt every 58us. The timer is reloaded on every
interrupt. This gives the nominal timimg for a 1 half bit. SPROG uses two
intervals for a 0 half bit.

<P>In version 3.2 and above, the "T n" command can be used to set a new value,
n, to be reloaded into the timer. At the moment it makes no check on the
value given so use with care. If you use "T" with no argument then the
current value is shown. By default this is 0x97. Here's an extract from the
source with comments on how it's calculated. note the PIC uses four clocks
per instruction so the cycle time Tcyc is 250ns at 16MHz, not 62.5ns.
<P>
	<UL>
	<LI>; Reload TMR0 for interrupt every 58us
	<LI>; Tcyc = 250ns @ 16MHz
	<LI>; Interrupt every 58/(.25) = 232 Tcyc
	<LI>; Value loaded into TMR0 needs to be adjusted for:
	<LI>; - TMR0 interrupt latency (3 Tcyc)
	<LI>; - Number of instructions from interrupt to reload
	<LI>; - TMR0 inhibit after reload (2 Tcyc with 2:1 prescaler)
	<LI>; Prescaler = 2:1
	<LI>; So value is 0 - (232 - 3 - 17 - 2)/2 = -105 = 0x97
	</UL>
<P>
You can see how to calculate the TMR0 reload value for other intervals.
Convert the negative result to two's complement and take the 8 LSBs. The
granularity is 0.5us. On each interupt, I turn both outputs off, wait 2us
and then turn one output on, actually more like 3us by the time the code
decides which output to turn on. This is to prevent shoot-through in the
MOSFETs.
<P>
The JMRI "Send command" menu item under the SPROG menu can be
used to send the T command to the SPROG.
   
<!--#include virtual="/Footer" -->
</body>
</html>

